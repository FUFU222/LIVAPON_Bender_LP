# セキュリティ診断・強化ガイド

LIVAPON LPコードベースに対して実施した脆弱性診断結果と、推奨される対策を以下に整理します。

## 1. 診断結果サマリー

| 重要度 | カテゴリ | 脆弱性概要 | 想定される影響 |
| :-- | :-- | :-- | :-- |
| 重大 | 認証・認可 | 管理API(`/api/bookings`)が無認証で公開されている | 顧客の氏名・メール・会社名を誰でも取得できる |
| 重大 | 権限管理 | 予約承認/拒否APIにアクセス制御が無い | 攻撃者が任意の予約を勝手に操作できる |
| 高 | インジェクション | メールHTMLにユーザー入力を直接埋め込んでいる | HTMLインジェクション(XSS)で管理者ブラウザが乗っ取られる |
| 高 | 可用性 | フォーム送信の回数制限が無い | 大量リクエストでSMTP制限超過、DoSを誘発 |
| 中 | データ保護 | 予約情報をメモリのみで保持 | サーバー再起動でデータ消失、メモリ枯渇リスク |

---

## 2. 想定攻撃シナリオ

### シナリオA: 個人情報の大量取得
1. 攻撃者が `curl https://lp.example.com/api/bookings` を実行。
2. サーバーは認証を求めずに全件JSONを返却。
3. 顧客名簿や連絡先がそのまま流出。

### シナリオB: 管理アカウントの乗っ取り
1. 問い合わせフォームのメッセージ欄に `<script>...</script>` を埋め込んで送信。
2. 管理者に届くHTMLメール上でスクリプトが実行され、クッキー等の機密情報を窃取。
3. 管理画面に不正ログインされ、全データが危険に晒される。

---

## 3. 推奨される強化策

### 3.1 認証・認可
- [ ] `/api/bookings` 系エンドポイントにAPIキー、もしくはNextAuth等のセッション認証を導入。
- [ ] 管理画面にも必ず同一の認証ロジックを適用し、未認証アクセスを遮断。

### 3.2 入力サニタイズ
- [ ] メール本文に挿入する値は `escapeHtml` などでエスケープ。
- [ ] `zod` などのバリデーションで型・文字数・形式を厳格にチェック。

### 3.3 レートリミット
- [ ] IPごとの送信回数を制限（例: 1時間あたり10回）。`upstash/ratelimit` やRedisを利用すると安全。

### 3.4 永続化
- [ ] `Map` ではなくSupabase/PostgreSQL等に保存し、再起動時のデータ消失を防止。

### 3.5 機密値の取り扱い
- [ ] `.env` をGitに含めない運用を継続し、`server-only` を活用してサーバー限定の値を守る。

---

## 4. 開発者チェックリスト
- [ ] `.env` が `.gitignore` に含まれている
- [ ] ユーザー入力を `dangerouslySetInnerHTML` やメールHTMLへ無加工で渡していない
- [ ] 管理機能へアクセスする際に必ず有効なセッション/APIキーを検証している
- [ ] 本番環境で `NODE_ENV=production` が設定されている
- [ ] `npm audit` 等で依存ライブラリの脆弱性を定期確認している

継続的に上記を見直し、必要に応じて `docs/` 配下へ詳細手順を追加してください。
